# ä» v6 å‡çº§

å¦‚æœå¯ç”¨äº†æ‰€æœ‰çš„æœªæ¥ç‰¹æ€§æ ‡å¿—ï¼Œé‚£ä¹ˆå‡çº§åˆ° v7 æ—¶å°±ä¸ä¼šæœ‰ç ´åæ€§çš„å˜æ›´ã€‚è¿™äº›æ ‡å¿—èƒ½è®©ä½ æ¯æ¬¡é’ˆå¯¹ä¸€é¡¹å˜æ›´æ¥æ›´æ–°ä½ çš„åº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½ åœ¨æ¯å®Œæˆä¸€ä¸ªæ­¥éª¤åè¿›è¡Œä¸€æ¬¡æäº¤å¹¶å‘å¸ƒï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰æ“ä½œã€‚

## æ›´æ–°åˆ°æœ€æ–°çš„ v6.x

é¦–å…ˆæ›´æ–°åˆ° v6.x çš„æœ€æ–°ç‰ˆæœ¬ï¼Œä»¥è·å–æœ€æ–°çš„æœªæ¥ç‰¹æ€§æ ‡å¿—ä»¥åŠæ§åˆ¶å°è­¦å‘Šä¿¡æ¯ã€‚

ğŸ‘‰ æ›´æ–°åˆ°æœ€æ–°çš„ v6 ç‰ˆæœ¬ã€‚

```sh
npm install react-router-dom@6
```

### v7_relativeSplatPath

**èƒŒæ™¯**

é’ˆå¯¹è¯¸å¦‚ `dashboard/*`ï¼ˆå°± `*` è€Œè¨€ï¼‰è¿™ç±»å¤šç‰‡æ®µé€šé…ç¬¦è·¯å¾„ï¼Œæ”¹å˜å…¶ç›¸å¯¹è·¯å¾„åŒ¹é…å’Œé“¾æ¥æ–¹å¼ã€‚å¦‚éœ€äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·[æŸ¥çœ‹å˜æ›´æ—¥å¿—](https://github.com/remix-run/react-router/blob/main/CHANGELOG.md#futurev7_relativesplatpath)ã€‚

ğŸ‘‰ **å¯ç”¨è¯¥ç‰¹æ€§æ ‡å¿—**

å¯ç”¨è¯¥ç‰¹æ€§æ ‡å¿—å–å†³äºè·¯ç”±å™¨çš„ç±»å‹ï¼š

```tsx
<BrowserRouter
  future={{
    v7_relativeSplatPath: true,
  }}
/>
```

```ts
createBrowserRouter(routes, {
  future: {
    v7_relativeSplatPath: true,
  },
});
```

**æ›´æ–°ä½ çš„ä»£ç **

å¦‚æœä½ æœ‰ä»»ä½•å¸¦æœ‰è·¯å¾„åŠé€šé…ç¬¦ï¼ˆä¾‹å¦‚ `<Route path="dashboard/*">` è¿™æ ·çš„ï¼‰çš„è·¯ç”±ï¼Œå¹¶ä¸”å…¶ä¸‹æ–¹å­˜åœ¨åƒ `<Link to="relative">` æˆ– `<Link to="../relative">` è¿™æ ·çš„ç›¸å¯¹é“¾æ¥ï¼Œé‚£ä¹ˆä½ å°†éœ€è¦æ›´æ–°ä½ çš„ä»£ç ã€‚

ğŸ‘‰ **å°† `<Route>` æ‹†åˆ†æˆä¸¤ä¸ª**

å°†ä»»ä½•åŒ…å«å¤šç‰‡æ®µé€šé…ç¬¦çš„ `<Route>` æ‹†åˆ†æˆä¸€ä¸ªå¸¦æœ‰è·¯å¾„çš„çˆ¶è·¯ç”±ä»¥åŠä¸€ä¸ªå¸¦æœ‰é€šé…ç¬¦çš„å­è·¯ç”±ï¼š

```tsx
<Routes>
  <Route path="/" element={<Home />} />
   <Route path="dashboard/*" element={<Dashboard />} /> // [!code --]
   <Route path="dashboard"> // [!code ++]
     <Route path="*" element={<Dashboard />} /> // [!code ++]
   </Route> // [!code ++]
</Routes>

// or
createBrowserRouter([
  { path: "/", element: <Home /> },
  {
     path: "dashboard/*", // [!code --]
     element: <Dashboard />, // [!code --]
     path: "dashboard", // [!code ++]
     children: [{ path: "*", element: <Dashboard /> }], // [!code ++]
  },
]);

```

ğŸ‘‰ **æ›´æ–°ç›¸å¯¹é“¾æ¥**

æ›´æ–°è¯¥è·¯ç”±æ ‘å†…çš„ä»»ä½• `<Link>` å…ƒç´ ï¼Œä½¿å…¶åŒ…å«é¢å¤–çš„â€œ..â€ç›¸å¯¹è·¯å¾„ç‰‡æ®µï¼Œä»¥ä¾¿èƒ½ç»§ç»­é“¾æ¥åˆ°åŒä¸€ä½ç½®ã€‚

```tsx
function Dashboard() {
  return (
    <div>
      <h2>Dashboard</h2>
      <nav>
         <Link to="/">Dashboard Home</Link> // [!code --]
         <Link to="team">Team</Link> // [!code --]
         <Link to="projects">Projects</Link> // [!code --]
         <Link to="../">Dashboard Home</Link> // [!code ++]
         <Link to="../team">Team</Link> // [!code ++]
         <Link to="../projects">Projects</Link> // [!code ++]
      </nav>

      <Routes>
        <Route path="/" element={<DashboardHome />} />
        <Route path="team" element={<DashboardTeam />} />
        <Route
          path="projects"
          element={<DashboardProjects />}
        />
      </Routes>
    </div>
  );
}
```

### v7_startTransition

**èƒŒæ™¯**

æ­¤é¡¹åŠŸèƒ½ä½¿ç”¨ `React.useTransition` è€Œé `React.useState` æ¥è¿›è¡Œè·¯ç”±å™¨çŠ¶æ€æ›´æ–°ã€‚å¦‚éœ€äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·[æŸ¥çœ‹å˜æ›´æ—¥å¿—](https://github.com/remix-run/react-router/blob/main/CHANGELOG.md#futurev7_starttransition)ã€‚

ğŸ‘‰ **å¯ç”¨è¯¥ç‰¹æ€§æ ‡å¿—**

```tsx
<BrowserRouter
  future={{
    v7_startTransition: true,
  }}
/>

// or
<RouterProvider
  future={{
    v7_startTransition: true,
  }}
/>

```

ğŸ‘‰ **æ›´æ–°ä½ çš„ä»£ç **

é™¤éä½ åœ¨ç»„ä»¶å†…éƒ¨ä½¿ç”¨äº† `React.lazy`ï¼Œå¦åˆ™ä½ æ— éœ€è¿›è¡Œä»»ä½•æ›´æ–°ã€‚

åœ¨ç»„ä»¶å†…éƒ¨ä½¿ç”¨ `React.lazy` ä¸ `React.useTransition`ï¼ˆæˆ–å…¶ä»–åœ¨ç»„ä»¶å†…éƒ¨åˆ›å»º promises çš„ä»£ç ï¼‰æ˜¯ä¸å…¼å®¹çš„ã€‚å°† `React.lazy` ç§»åˆ°æ¨¡å—ä½œç”¨åŸŸä¸­ï¼Œå¹¶åœæ­¢åœ¨ç»„ä»¶å†…éƒ¨åˆ›å»º promisesã€‚è¿™å¹¶éæ˜¯ `React Router` çš„é™åˆ¶ï¼Œè€Œæ˜¯ `React` çš„é”™è¯¯ç”¨æ³•å¯¼è‡´çš„ã€‚ 

### v7_fetcherPersist

> [!TIP] æç¤ºï¼š
> å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ `<RouterProvider>`ï¼Œåˆ™å¯ä»¥è·³è¿‡æ­¤é¡¹ã€‚

**èƒŒæ™¯**

ç°åœ¨ï¼Œè·å–å™¨ï¼ˆfetcherï¼‰çš„ç”Ÿå‘½å‘¨æœŸåŸºäºå®ƒä½•æ—¶è¿”å›åˆ°ä¸€ä¸ªç©ºé—²çŠ¶æ€ï¼Œè€Œéå…¶æ‰€å±ç»„ä»¶å¸è½½ä¹‹æ—¶ã€‚å¦‚éœ€äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·[æŸ¥çœ‹å˜æ›´æ—¥å¿—](https://github.com/remix-run/react-router/blob/main/CHANGELOG.md#persistence-future-flag-futurev7_fetcherpersist)ã€‚

ğŸ‘‰ **å¯ç”¨è¯¥ç‰¹æ€§æ ‡å¿—**

```ts
createBrowserRouter(routes, {
  future: {
    v7_fetcherPersist: true,
  },
});
```

**æ›´æ–°ä½ çš„ä»£ç **

å®ƒä¸å¤ªå¯èƒ½ä¼šå½±å“åˆ°ä½ çš„åº”ç”¨ç¨‹åºã€‚ä½ å¯èƒ½éœ€è¦æ£€æŸ¥ä¸€ä¸‹ `useFetchers` çš„å„ç§ä½¿ç”¨æƒ…å†µï¼Œå› ä¸ºå®ƒä»¬çš„å­˜ç»­æ—¶é—´å¯èƒ½ä¼šæ¯”ä¹‹å‰æ›´é•¿ã€‚å–å†³äºä½ æ­£åœ¨è¿›è¡Œçš„æ“ä½œï¼Œä½ æ¸²æŸ“æŸäº›å†…å®¹çš„æ—¶é•¿å¯èƒ½ä¼šæ¯”ä¹‹å‰æ›´ä¹…ã€‚ 

### v7_normalizeFormMethod

> [!TIP] æç¤ºï¼š
> å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ `<RouterProvider>`ï¼Œåˆ™å¯ä»¥è·³è¿‡æ­¤é¡¹ã€‚

è¿™ä¼šå°† `formMethod` å­—æ®µè§„èŒƒåŒ–ä¸ºå¤§å†™çš„ HTTP æ–¹æ³•ï¼Œä»¥ä¸ `fetch()` å‡½æ•°çš„è¡Œä¸ºä¿æŒä¸€è‡´ã€‚å¦‚éœ€äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·[æŸ¥çœ‹å˜æ›´æ—¥å¿—](https://github.com/remix-run/react-router/blob/main/CHANGELOG.md#futurev7_normalizeformmethod)ã€‚

ğŸ‘‰ **å¯ç”¨è¯¥ç‰¹æ€§æ ‡å¿—**

```ts
createBrowserRouter(routes, {
  future: {
    v7_normalizeFormMethod: true,
  },
});
```

**æ›´æ–°ä½ çš„ä»£ç **

å¦‚æœä½ çš„ä»»ä½•ä»£ç æ­£åœ¨æ£€æŸ¥å°å†™çš„ HTTP æ–¹æ³•ï¼Œé‚£ä¹ˆä½ å°†éœ€è¦å¯¹å…¶è¿›è¡Œæ›´æ–°ï¼Œæ”¹ä¸ºæ£€æŸ¥å¤§å†™çš„ HTTP æ–¹æ³•ï¼ˆæˆ–è€…å¯¹å…¶è°ƒç”¨ `toLowerCase()` æ–¹æ³•æ¥è¿›è¡Œè½¬æ¢åå†æ£€æŸ¥ï¼‰ã€‚ 

ğŸ‘‰ å°† `formMethod` ä¸å¤§å†™å½¢å¼è¿›è¡Œå¯¹æ¯”ã€‚

```ts
useNavigation().formMethod === "post" // [!code --]
useFetcher().formMethod === "get"; // [!code --]
useNavigation().formMethod === "POST" // [!code ++]
useFetcher().formMethod === "GET"; // [!code ++]
```

### v7_partialHydration

> [!TIP] æç¤ºï¼š
> å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ `<RouterProvider>`ï¼Œåˆ™å¯ä»¥è·³è¿‡æ­¤é¡¹ã€‚

è¿™ä½¿å¾—æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰æ¡†æ¶èƒ½å¤Ÿä»…æä¾›éƒ¨åˆ† hydrationï¼ˆæ°´åˆä½œç”¨ï¼Œæ­¤å¤„æŒ‡åœ¨ SSR ä¸­å…³è”æœåŠ¡å™¨ç«¯æ¸²æŸ“å†…å®¹ä¸å®¢æˆ·ç«¯äº¤äº’ç­‰ç›¸å…³æ“ä½œï¼‰æ•°æ®ã€‚ä½ ä¸å¤ªå¯èƒ½éœ€è¦ä¸ºæ­¤æ‹…å¿ƒï¼Œåªéœ€å¼€å¯ç›¸åº”ç‰¹æ€§æ ‡å¿—å°±è¡Œã€‚å¦‚éœ€äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·[æŸ¥çœ‹å˜æ›´æ—¥å¿—](https://github.com/remix-run/react-router/blob/main/CHANGELOG.md#partial-hydration)ã€‚ 

ğŸ‘‰ **å¯ç”¨è¯¥ç‰¹æ€§æ ‡å¿—**

```ts
createBrowserRouter(routes, {
  future: {
    v7_partialHydration: true,
  },
});
```

**æ›´æ–°ä½ çš„ä»£ç **

åœ¨ä½¿ç”¨éƒ¨åˆ†æ°´åˆï¼ˆhydrationï¼‰çš„æƒ…å†µä¸‹ï¼Œä½ éœ€è¦æä¾›ä¸€ä¸ª `HydrateFallback` ç»„ä»¶ï¼Œä»¥ä¾¿åœ¨åˆå§‹æ°´åˆæœŸé—´è¿›è¡Œæ¸²æŸ“ã€‚æ­¤å¤–ï¼Œå¦‚æœä½ ä¹‹å‰ä½¿ç”¨è¿‡ `fallbackElement`ï¼Œé‚£ä¹ˆéœ€è¦å°†å…¶ç§»é™¤ï¼Œå› ä¸ºå®ƒç°åœ¨å·²è¢«å¼ƒç”¨ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ ä¼šå¸Œæœ›å°†ä¹‹å‰çš„ `fallbackElement` é‡æ–°ç”¨ä½œ `HydrateFallback` ç»„ä»¶ã€‚ 

ğŸ‘‰ **ç”¨ `HydrateFallback` æ›¿æ¢ `fallbackElement`**

```tsx
const router = createBrowserRouter(
  [
    {
      path: "/",
      Component: Layout,
       HydrateFallback: Fallback, // [!code ++]
      // or
       hydrateFallbackElement: <Fallback />, // [!code ++]
      children: [],
    },
  ],
);


<RouterProvider
  router={router}
   fallbackElement={<Fallback />} // [!code --]
/>
```

### v7_skipActionErrorRevalidation

> [!TIP] æç¤ºï¼š
> å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ `createBrowserRouter`ï¼Œåˆ™å¯ä»¥è·³è¿‡æ­¤é¡¹ã€‚

å½“å¯ç”¨æ­¤ç‰¹æ€§æ ‡å¿—åï¼Œåœ¨ action æŠ›å‡ºæˆ–è¿”å›çŠ¶æ€ç ä¸º `4xx`/`5xx` çš„ `Response`ï¼ŒåŠ è½½å™¨ï¼ˆloadersï¼‰é»˜è®¤å°†ä¸å†é‡æ–°éªŒè¯ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥é€šè¿‡ `shouldRevalidate` ä»¥åŠ `actionStatus` å‚æ•°æ¥é€‰æ‹©é‡æ–°è¿›è¡ŒéªŒè¯ã€‚

ğŸ‘‰ **å¯ç”¨è¯¥ç‰¹æ€§æ ‡å¿—**

```ts
createBrowserRouter(routes, {
  future: {
    v7_skipActionErrorRevalidation: true,
  },
});
```

**æ›´æ–°ä½ çš„ä»£ç **

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½æ— éœ€å¯¹åº”ç”¨ç¨‹åºä»£ç è¿›è¡Œæ›´æ”¹ã€‚é€šå¸¸æ¥è¯´ï¼Œå¦‚æœæŸä¸ª action å‡ºç°é”™è¯¯ï¼Œæ•°æ®ä¸å¤ªå¯èƒ½å·²è¢«ä¿®æ”¹ï¼Œä¹Ÿå°±ä¸éœ€è¦é‡æ–°éªŒè¯ã€‚å¦‚æœä½ çš„ä»»ä½•ä»£ç åœ¨ action å‡ºé”™çš„åœºæ™¯ä¸‹ç¡®å®ä¿®æ”¹äº†æ•°æ®ï¼Œé‚£ä½ æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š

ğŸ‘‰ **é€‰é¡¹1ï¼šä¿®æ”¹ `action`ï¼Œä»¥é¿å…åœ¨å‡ºé”™åœºæ™¯ä¸‹è¿›è¡Œæ•°æ®å˜æ›´**

```tsx
// ä¿®æ”¹å‰
async function action() {
  await mutateSomeData();
  if (detectError()) {
    throw new Response(error, { status: 400 });
  }
  await mutateOtherData();
  // ...
}

// ä¿®æ”¹å
async function action() {
  if (detectError()) {
    throw new Response(error, { status: 400 });
  }
  // ç°åœ¨æ‰€æœ‰æ•°æ®åœ¨éªŒè¯åæ‰å¼€å§‹å˜æ›´
  await mutateSomeData();
  await mutateOtherData();
  // ...
}

```

ğŸ‘‰ **é€‰é¡¹2ï¼šé€šè¿‡ `shouldRevalidate` å’Œ `actionStatus` é€‰æ‹©å¯ç”¨é‡æ–°éªŒè¯**

```tsx
async function action() {
  await mutateSomeData();
  if (detectError()) {
    throw new Response(error, { status: 400 });
  }
  await mutateOtherData();
}

async function loader() { ... }

function shouldRevalidate({ actionStatus, defaultShouldRevalidate }) {
  if (actionStatus != null && actionStatus >= 400) {
    // å½“ actions è¿”å› 4xx/5xx çŠ¶æ€æ—¶é‡æ–°éªŒè¯æ­¤åŠ è½½å™¨
    return true;
  }
  return defaultShouldRevalidate;
}

```

## å¼ƒç”¨è¯´æ˜

`json` å’Œ `defer` æ–¹æ³•å·²è¢«å¼ƒç”¨ï¼Œå»ºè®®æ”¹ä¸ºè¿”å›åŸå§‹å¯¹è±¡ã€‚

```tsx
async function loader() {
  return json({ data }); // [!code --]
  return { data };  // [!code ++]
```

å¦‚æœä½ ä¹‹å‰ä½¿ç”¨ `json` æ–¹æ³•å°†æ•°æ®åºåˆ—åŒ–ä¸ºJSONæ ¼å¼ï¼Œé‚£ä¹ˆç°åœ¨å¯ä»¥æ”¹ç”¨åŸç”Ÿçš„ `Response.json()` æ–¹æ³•æ¥æ›¿ä»£ã€‚

## æ›´æ–°åˆ° v7

æ—¢ç„¶ä½ çš„åº”ç”¨ç¨‹åºå·²ç»å®Œæˆäº†ä¸Šè¿°ç›¸å…³æ›´æ–°ï¼ˆä¸å‰æ–‡æåˆ°çš„æ›´æ–°å†…å®¹ä¿æŒåŒæ­¥ï¼‰ï¼Œé‚£ä¹ˆç†è®ºä¸Šä½ å°±å¯ä»¥æ¯«æ— é—®é¢˜åœ°ç›´æ¥æ›´æ–°åˆ°ç‰ˆæœ¬ 7 äº†ã€‚

ğŸ‘‰ **å®‰è£… v7 ç‰ˆæœ¬**

```sh
npm install react-router-dom@latest
```

ğŸ‘‰ **ç”¨ react-router æ›¿æ¢æ‰ react-router-dom**

åœ¨ç‰ˆæœ¬ 7 ä¸­ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦ `â€œreact-router-domâ€` äº†ï¼Œå› ä¸ºç›¸å…³çš„è½¯ä»¶åŒ…å·²ç»è¿›è¡Œäº†ç®€åŒ–ã€‚ä½ å¯ä»¥ä» `â€œreact-routerâ€` ä¸­å¯¼å…¥æ‰€æœ‰å†…å®¹ã€‚

```sh
npm uninstall react-router-dom
npm install react-router@latest
```

æ³¨æ„åœ¨ package.json ä¸­ï¼Œä½ åªéœ€è¦ `â€œreact-routerâ€`ã€‚

ğŸ‘‰ **æ›´æ–°å¯¼å…¥**

æ”¹ä¸ºä½¿ç”¨ `react-router` å¯¼å…¥ï¼š

```ts
import { useLocation } from "react-router-dom"; // [!code --]
import { useLocation } from "react-router"; // [!code ++]
```

ä½ æ— éœ€æ‰‹åŠ¨æ›´æ–°å¯¼å…¥è¯­å¥ï¼Œå¯ä½¿ç”¨è¿™æ¡å‘½ä»¤æ¥è¿›è¡Œæ“ä½œã€‚ä¸è¿‡è¦ç¡®ä¿ä½ çš„ Git å·¥ä½œæ ‘æ˜¯å¹²å‡€çš„ï¼ˆå³æ²¡æœ‰æœªæäº¤çš„æ›´æ”¹ç­‰æƒ…å†µï¼‰ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå¦‚æœå‘½ä»¤è¿è¡Œç»“æœä¸ç¬¦åˆé¢„æœŸï¼Œä½ è¿˜å¯ä»¥è¿›è¡Œå›æ»šæ“ä½œã€‚ 

```sh
find ./path/to/src \( -name "*.tsx" -o -name "*.ts" -o -name "*.js" -o -name "*.jsx" \) -type f -exec sed -i '' 's|from "react-router-dom"|from "react-router"|g' {} +
```

å¦‚æœä½ å®‰è£…äº† GNU sedï¼ˆå¤§å¤šæ•° Linux å‘è¡Œç‰ˆéƒ½å·²å®‰è£…ï¼‰ï¼Œé‚£å°±æ”¹ç”¨è¿™æ¡å‘½ä»¤ï¼š

```sh
find ./path/to/src \( -name "*.tsx" -o -name "*.ts" -o -name "*.js" -o -name "*.jsx" \) -type f -exec sed -i 's|from "react-router-dom"|from "react-router"|g' {} +
```

ğŸ‘‰ **æ›´æ–°ç‰¹å®šäº DOM çš„å¯¼å…¥å†…å®¹**

`RouterProvider` å’Œ `HydratedRouter` æ¥è‡ªæ·±å±‚å¯¼å…¥ï¼Œå› ä¸ºå®ƒä»¬ä¾èµ–äº `â€œreact-domâ€` ï¼š

```ts
import { RouterProvider } from "react-router-dom"; // [!code --]
import { RouterProvider } from "react-router/dom"; // [!code ++]
```

è¯·æ³¨æ„ï¼Œå¯¹äºé DOM ä¸Šä¸‹æ–‡ï¼ˆæ¯”å¦‚ Jest æµ‹è¯•ç¯å¢ƒï¼‰ï¼Œä½ åº”è¯¥ä½¿ç”¨é¡¶çº§å¯¼å…¥ï¼š

```ts
import { RouterProvider } from "react-router-dom"; // [!code --]
import { RouterProvider } from "react-router"; // [!code ++]
```






